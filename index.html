<!-- 
State of the Union:
-the files Point.js, Line.js, and Circle.js exist in the js folder
-test.html supports Oxford commas
-for now, objects placed at the beginning of the game shall be green, goals
  shall be red, and intermediates shall be blue
-test.html will steal from canvas.html until its superiority is recognized, then it
  will erase any trace of the former canvas.html

Next Steps:
-build a basic UI to allow user to create lines, cirlces
-automatically compute all intersections and create points for them whenever a
new line or cirlce object is created
-decide on a good data structure to allow the previous to be simple/efficient
-->

<html>
  <head>
    <script type="text/javascript"  src="http://code.jquery.com/jquery-latest.js"> </script>
    <script type="text/javascript"  src="js/Point.js"> </script>
    <script type="text/javascript"  src="js/Line.js"> </script>
    <script type="text/javascript"  src="js/Circle.js"> </script>

    <style type="text/css">
      #canvasDiv{
        width:400; 
        height:400;
      }

      #initial{
        z-index:1;
        position:absolute;
      }
        
      #drawn{
        z-index:2;
        position:absolute;
      }

      #current{
        z-index:3;
        position:absolute;
      }

      #highlighted{
        z-index:4;
        position:absolute;
      }

      #user{
        z-index:5;
        position:absolute;
      }

      #buttonDiv{
        height:30px; 
        width:400px; 
        border:black 1px solid;
        display:table-cell;
        vertical-align:middle;
        text-align:center;
      }

      #messageDiv{
        height:30px; 
        width:400px; 
        border:black 1px solid;
        display:table-cell;
        vertical-align:middle;
        text-align:center;
      }

    </style>

    <script>

      function init(){
        var canvasInitial = $("#initial")[0];
        var ctxInitial = canvasInitial.getContext("2d");

        var canvasDrawn = $("#drawn")[0];
        var ctxDrawn = canvasDrawn.getContext("2d");

        var canvasCurrent = $("#current")[0];
        var ctxCurrent = canvasCurrent.getContext("2d");

        var canvasHighlighted = $("#highlighted")[0];
        var ctxHighlighted = canvasHighlighted.getContext("2d");

        var canvasUser = $("#user")[0];
        var ctxUser = canvasUser.getContext("2d");
        //All mouse events occur on user layer as it is on top

        //Offset so we can compute location on canvas form location on screen
        var offsetTop = canvasInitial.offsetTop;
        var offsetLeft = canvasInitial.offsetLeft;

        //Arrays
        var pointArray = [];
        var lineArray = [];
        var circleArray = [];

        var intersectionPoints = [];

        //Special Points
        var mouseOverPoint = null; 
        var currentPoint1 = null;
        var currentPoint2 = null;
        
        //test points
        var point1 = new Point(ctxInitial, 50, 50);
        var point2 = new Point(ctxInitial, 50, 100);
        var point3 = new Point(ctxInitial, 50, 150);
        var point4 = new Point(ctxInitial, 50, 200);
        var point5 = new Point(ctxInitial, 50, 250);
        pointArray.push(point1, point2, point3, point4, point5);

        //Button Events
        $("#startButton").click(function() { 
          console.log("clicked start"); clickStart(pointArray); 
        });

        $("#lineButton").click(function() { 
          console.log("clicked line"); clickLine(ctxDrawn, currentPoint1, currentPoint2, lineArray); 
        });
        
        $("#circleButton").click(function() { 
          console.log("clicked circle"); clickCircle(ctxDrawn, currentPoint1, currentPoint2, circleArray); 
        });

        //Mouse Events
        $("#user").mousemove(function(e) { 
          mouseOverPoint = mouseMove(ctxHighlighted, pointArray, e.pageX - offsetLeft, e.pageY - offsetTop);
        });

        $("#user").mousedown(function(e) {
          if (mouseOverPoint){
            var clickedPoints = clickCanvas(ctxCurrent, pointArray, lineArray, circleArray,  mouseOverPoint, currentPoint1, currentPoint2);
            currentPoint1 = clickedPoints[0];
            currentPoint2 = clickedPoints[1];


            
            ctxCurrent.clearRect(0,0,400,400);
            if (currentPoint1) currentPoint1.draw("#00FF00");
            if (currentPoint2) currentPoint2.draw("#FF0000");
          }
        });
      }

      function clickCanvas (ctx, pointArray, lineArray, circleArray, mouseOverPoint, pt1, pt2){
        if (!pt2) {
          console.log("First point added:", mouseOverPoint.toString());
          return [pt1, new Point(ctx, mouseOverPoint.getX(), mouseOverPoint.getY())];
        }
        else if (!pt1) {
          if (pt2.isSame(mouseOverPoint)){
            console.log("Trying to add same point, no changes");
            return [pt1, pt2];
          }
          else {
            console.log("Second point added: pt1: ", pt2.toString(), "pt2: ", mouseOverPoint.toString());
            return[pt2, new Point(ctx, mouseOverPoint.getX(), mouseOverPoint.getY())];
          }
        }
        else if (pt2.isSame(mouseOverPoint))
        {
          console.log("Trying to add same point, no changes");
          return [pt1, pt2];
        }
        else{
          console.log("Jimmy the points: pt1: ", pt2.toString(), "pt2: ", mouseOverPoint.toString());
          return [pt2, new Point(ctx, mouseOverPoint.getX(), mouseOverPoint.getY())];
        }
      }

      function mouseMove (ctx, pointArray, x, y){
        var i = 0;
        while (i <= pointArray.length - 1){
          var currPoint = pointArray[i];

          if (pointPointDistance(x, y, currPoint.getX(), currPoint.getY()) <= 5){
            myPoint = new Point(ctx, currPoint.getX(), currPoint.getY());
            return myPoint;
          }
          i++;
        }
        return null;
      }

      function pointPointDistance (pt1X, pt1Y, pt2X, pt2Y)
      {
        return Math.sqrt(Math.pow(pt1X - pt2X, 2) + Math.pow(pt1Y - pt2Y, 2));
      }

      function clickStart(pointArray){
        for(var i = 0; i < pointArray.length; i++){
          pointArray[i].draw();
        }
      } 

      function clickLine(ctx, currentPoint1, currentPoint2, lineArray, intersectionPoints){
        if (currentPoint1 && currentPoint2)
        {
          var line = new Line(ctx, currentPoint1, currentPoint2);

          var contains = false;

          for (var i = 0; i < lineArray.length; i++){
             if (line.isSame(lineArray[i])){
                contains = true;
                break;
            }
          }
          
          if (!contains){

            for(var i = 0; i < lineArray.length; i++){
              var intersections = line.intersectsWith(lineArray[i]);

              intersections[0] && intersections[0].draw();
            }

            lineArray.push(line);
          }

          console.log(line.toString());
          line.draw();
        }
      }

      function clickCircle(ctx, currentPoint1, currentPoint2, circleArray){
        if (currentPoint1 && currentPoint2)
        {
          var circle = new Circle(ctx, currentPoint1, currentPoint2);

          var contains = false;

          for (var i = 0; i < circleArray.length; i++){
            if (circle.isSame(circleArray[i])){
                contains = true;
                break;
            }
          }
          
          if (!contains){
            circleArray.push(circle);
          }

          console.log(circle.toString());
          circle.draw();
        }
      }
   </script>

  </head>
  <body onload="init();">
    <!--make a few divs for canvas, buttons, messages-->
    <div id="everythingDiv">

      <div id="canvasDiv" >
        <canvas id="initial" width="400" height="400"></canvas>
        <canvas id="drawn" width="400" height="400"></canvas>
        <canvas id="current" width="400" height="400"></canvas>
        <canvas id="highlighted" width="400" height="400"></canvas>
        <canvas id="user" width="400" height="400"></canvas>
      </div>
      <br>
      <div id="buttonDiv"> 
        <button id="startButton"> Start </button>
        <button id="lineButton"> Line </button>
        <button id="circleButton"> Circle </button>
      </div>
      <br>
      <div id = "messageDiv">
        This is where messages would go
      </div>
    </div>

  </body>
</html>
